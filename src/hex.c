/*
 * Copyright (c) 2024
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include "hex.h"


static const char *hex_chars_lower = "0123456789abcdef";

static const char *hex_chars_upper = "0123456789ABCDEF";

static const uint8_t hex_values[256] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 00-07 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 08-0f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 18-17 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 10-1f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 20-27 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 28-2f */
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, /* 30-37 */
    0x08, 0x09, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 38-3f */
    0xff, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0xff, /* 40-47 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 48-4f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 50-57 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 58-5f */
    0xff, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0xff, /* 60-67 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 68-67 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 70-77 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 78-7f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 80-87 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 88-8f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 90-97 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 98-9f */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* a0-a7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* a8-af */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* b0-b7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* b8-bf */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* c0-c7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* c8-cf */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* d0-d7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* d8-df */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* e0-e7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* e8-ef */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* f0-f7 */
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* f8-ff */
};


void hex_from_bytes(const void *bin, size_t bin_len, bool upper, char *hex)
{
    const uint8_t *in = bin;
    const char *hex_chars = upper ? hex_chars_upper : hex_chars_lower;

    for (size_t i = 0; i < bin_len; i++) {
        hex[2 * i] = hex_chars[(in[i] >> 4) & 0x0f];
        hex[2 * i + 1] = hex_chars[in[i] & 0x0f];
    }

    if (bin_len > 0) {
        hex[2 * bin_len] = 0;
    }
}

int32_t hex_to_bytes(const char *hex, size_t len, void *bin)
{
    if (len % 2 != 0) {
        return -1;
    }

    uint8_t *out = bin;
    size_t byte_len = len / 2;

    for (size_t i = 0; i < byte_len; i++, hex += 2) {
        uint8_t hi = hex_values[(uint8_t) hex[0]];
        uint8_t lo = hex_values[(uint8_t) hex[1]];

        if (hi == 0xff || lo == 0xff) {
            return -1;
        }

        out[i] = (hi << 4) | lo;
    }

    return 0;
}
